/// https://adventofcode.com/2024/day/14
module AdventOfCode2024.Day14

open AdventOfCode.Common

let data = EmbeddedResource.loadText "Data/Day14.txt"

let testData =
   seq {
      "p=0,4 v=3,-3"
      "p=6,3 v=-1,-3"
      "p=10,3 v=-1,2"
      "p=2,0 v=2,-1"
      "p=0,0 v=1,3"
      "p=3,0 v=-2,-2"
      "p=7,6 v=-1,-3"
      "p=3,0 v=-1,-2"
      "p=9,3 v=2,3"
      "p=7,3 v=-1,2"
      "p=2,4 v=2,-3"
      "p=9,5 v=-3,-3"
   }

let testMapDim = { R = 7; C = 11 }

let mapDim = { R = 103; C = 101 }

type Robot =
   { Position : Vector2
     Velocity : Vector2 }

let robots =
   data
   |> Seq.map (function
      | Regex "p=(\d+),(\d+) v=(-?\d+),(-?\d+)" [ Int64 pc; Int64 pr; Int64 vc; Int64 vr ] ->
         { Position = { R = pr; C = pc }
           Velocity = { R = vr; C = vc } }
      | _ -> raise invalidInput)
   |> Seq.toList

let simulate (iterations : int) (robots : List<Robot>) =
   robots
   |> List.map (fun robot ->
      let rawPosition = robot.Position + iterations * robot.Velocity
      { robot with Position = { R = rawPosition.R %% mapDim.R
                                C = rawPosition.C %% mapDim.C } })

let tryClassify (position : Vector2) =
   match compare position.R (mapDim.R / 2L), compare position.C (mapDim.C / 2L) with
   | -1, -1 -> Some 1
   | -1,  1 -> Some 2
   |  1, -1 -> Some 3
   |  1,  1 -> Some 4
   | _      -> None
   
let part1 () =
   robots
   |> simulate 100
   |> List.map _.Position
   |> List.choose tryClassify
   |> List.countBy id
   |> List.map snd
   |> List.reduce (*) 

let sprintRobots (robots : List<Robot>) =
   let robotsByPosition =
      robots
      |> List.countBy _.Position
      |> Map.ofSeq
   
   List.init (int mapDim.R) (fun r ->
      Seq.init (int mapDim.C) (fun c->
         match robotsByPosition |> Map.tryFind { R = r; C = c } with
         | Some count -> $"%d{count}"
         | None -> ".")
      |> String.concat "")
   
let part2 () =
   robots
   |> simulate 7603
   |> sprintRobots

let part1Expected = 224438715

let part2Expected =
   [
      "...................................................1................................................."
      "....................................................................................................."
      "....................................................................................................."
      "..............................................................................................1......"
      ".........................1............1................1............11..............................."
      "..........................................................................1..........1...1..........."
      "...........................1........................................................................."
      ".........................1...........1.........................................1....................."
      "..........................................................1.................1.................1......"
      "..............................................................1......................................"
      ".................................1..................................................1................"
      ".........1.................................................................1........................."
      "..............................................................1......................................"
      "..........................1..............................................11.........................."
      "..1....1..................1..................1....1.................................................."
      "....................................................................................................."
      "....................................................................................................."
      "....................................................1................................................"
      "...1......1.........................................................................................."
      "....................................................................................................."
      "1...................................................................................................."
      "....1.1...............................................................................1.............."
      ".........................1..........................................................................."
      "..........1..........................................................................1....1.........."
      ".................1..................................................................................."
      ".....................1..............................................................................."
      ".........................................................................................1..........."
      "............................1..................................1..................1.................."
      "............................1........................................................................"
      "..........................................1.........................................................."
      ".............1..................................................................1...................."
      "....................................................1................................................"
      "......................1..........................................................1.1......1.........1"
      "..........................1......................................1..........................1........"
      "....................................................................................................."
      "..............1......................................................................................"
      "..................................1...............................................1.................."
      "........................1..........1................................................................."
      ".......1.........................1...1..............................................................."
      "....................................................................................................."
      "......................................1.........1...................................................."
      "...................................................................1................................."
      "....................1111111111111111111111111111111.......................1.........................."
      "1...................1.............................1.................................................1"
      "..1.................1.............................1......1..........................................."
      "....................1.............................1.................................................."
      "....................1.............................1..........................................1......."
      "................1...1..............1..............1.................................................."
      ".1..................1.............111.............1.................................................."
      "....................1............11111............1........................................1........."
      ".......1............1...........1111111...........1.................................................."
      "....................1..........111111111..........1....1....................................1........"
      "....................1............11111............1.................................................."
      "......1........1....1...........1111111...........1.................................................."
      "....................1..........111111111..........1.............................1...................."
      "....................1.........11111111111.........1..........................................1......."
      "....................1........1111111111111........1.................................................."
      "..................1.1..........111111111..........1.................................................."
      "....................1.........11111111111.........1.....1.......................................1...."
      "....................1........1111111111111........1..................................1..............."
      "....................1.......111111111111111.......1.................................................."
      "....................1......11111111111111111......1.................................................."
      "....................1........1111111111111........1.................................................."
      "....................1.......111111111111111.......1.................................................."
      ".................1..1......11111111111111111......1.................................................."
      "....................1.....1111111111111111111.....1.................................................."
      "..........1.........1....111111111111111111111....1.........................................1........"
      "................1...1.............111.............1...........................1.................1...."
      "....................1.............111.............1..........1......................................."
      "....................1.............111.............1......1..........................................."
      "....................1.............................1............................................1....."
      "....................1.............................1.................................................."
      "....................1.............................1.................................................."
      "....................1.............................1.............................1...................."
      "....................1111111111111111111111111111111.........1.................1......................"
      "..................................................................1.................................."
      "..........1.........................................................................................."
      ".............................1...........................................1..........................."
      "....................................................................................................."
      "....11..............................................................................................."
      ".................................................................................1................1.1"
      ".......................1...............................................1............................."
      ".............................1......................................................................."
      "...............1.....................................................11.............................."
      "....................................................................................................."
      "......................1.........................1..................................1......1.........."
      "................................1...................................................................1"
      ".1....................................................................1.............................."
      "...............1....................................................................................."
      "....................................................................................................."
      ".....................................................................1..............1................"
      "..........................................................................................1.........."
      "....................................................................................................1"
      ".......................................................1............................................."
      "...............1....................................................................................."
      "..........1.........................................................................................."
      "....................................................................................................."
      "...............1....................................................................................."
      "....1...................1......................................................................1....."
      ".....................1..............................................................................."
      ".........................................................1......................1...................."
      "............................1..............................1...................................1....."
      ".......................................................................1.........................1..."
   ]
